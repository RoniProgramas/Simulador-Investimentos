<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulador de Carteiras</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<meta name="theme-color" content="#0b132b">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>

<style>
:root{
  --bg:#0b132b; --bg-2:#0e1b39; --panel:#0f1f3f; --stroke:#223a6a;
  --accent:#00c853; --accent-2:#43d38e;
  --text:#eef3ff; --muted:#a9bbd8; --shadow:0 10px 30px rgba(0,0,0,.35);
}
[data-theme="light"]{
  --bg:#f6f8fc; --bg-2:#ffffff; --panel:#ffffff; --stroke:#dfe7f3;
  --text:#0e1b2b; --muted:#5a6d86; --shadow:0 8px 24px rgba(16,44,84,.10);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:radial-gradient(1200px 800px at 20% -10%, #13305f 0%, var(--bg) 55%) no-repeat fixed;
  color:var(--text); font-family:Inter, system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
}
header{
  padding:24px 16px; text-align:center; border-bottom:1px solid var(--stroke);
  background:linear-gradient(180deg, rgba(255,255,255,.04), transparent);
}
header h1{margin:0; font-size:1.75rem; letter-spacing:.2px}
header p{margin:.5rem auto 0; color:var(--muted); max-width:920px}

.container{max-width:1360px; margin:18px auto; padding:0 16px}
.grid{
  display:grid;
  grid-template-columns: 50% 50%;
  gap:16px;
}
.grid > .card{ min-width:0; }
@media (max-width:1100px){
  .grid{ grid-template-columns:1fr; }
}

.card{
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  border:1px solid var(--stroke); border-radius:16px; padding:16px;
  box-shadow:var(--shadow); backdrop-filter:blur(6px);
}
h3{margin:0 0 8px 0; font-size:1.05rem}
h4{margin:0 0 10px 0}
.small{font-size:.9rem; color:var(--muted)}

.row{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px}
@media (max-width:1024px){.row{grid-template-columns:repeat(2,minmax(0,1fr))}}

label{display:block; font-size:.85rem; color:var(--muted); margin:0 0 6px 6px}
input, select{
  width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--stroke);
  background:var(--panel); color:var(--text); outline:none; transition:.15s border, .15s box-shadow;
}
input:focus, select:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,200,83,.15)}

table{width:100%; border-collapse:separate; border-spacing:0 8px; margin-top:8px}
th, td{padding:10px 12px; font-size:.92rem}
thead th{color:var(--muted); font-weight:600}
tbody tr{
  background:var(--panel); border:1px solid var(--stroke);
  box-shadow:var(--shadow); border-radius:12px;
}
tbody td:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
tbody td:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}
tbody td{border-top:1px solid var(--stroke); border-bottom:1px solid var(--stroke)}
tbody td+td{border-left:1px solid var(--stroke)}

.btn{
  display:inline-flex; align-items:center; gap:8px; border:0; cursor:pointer;
  background:var(--accent); color:#072716; font-weight:700; padding:10px 14px; border-radius:12px;
  transition:transform .05s ease, box-shadow .2s ease;
}
.btn:hover{box-shadow:0 6px 18px rgba(0,200,83,.25)}
.btn:active{transform:translateY(1px)}
.btn.secondary{background:transparent; color:var(--text); border:1px solid var(--stroke)}
.iconbtn{background:#11254b; border:1px solid #2a4275; color:#e7eeff; border-radius:8px; padding:6px 10px; cursor:pointer}
.iconbtn.danger{background:#4b1120; border-color:#7a2840}

/* ====== TABELA ====== */
.table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
#assetsTable{ width:100%; table-layout:fixed; }
#assetsTable col.usar  { width:64px; }
#assetsTable col.ativo { width:240px; }
#assetsTable col.ret   { width:100px; }
#assetsTable col.vol   { width:100px; }
#assetsTable col.peso  { width:96px; }
#assetsTable col.acoes { width:110px; }

#assetsTable td input[type="text"],
#assetsTable td input[type="number"]{
  width:100%; min-width:90px;
  height:44px; padding:10px 12px;
  font-size:1rem; font-variant-numeric:tabular-nums;
  background:var(--panel); color:var(--text);
  border-radius:12px; caret-color:var(--text);
  text-overflow:clip;
}
#assetsTable td input[type="number"]{ text-align:right; }
#assetsTable td input[type="checkbox"]{ width:auto; height:18px; }

/* toast + spinner */
.toast{
  position:fixed; right:18px; bottom:18px; background:var(--panel); color:var(--text);
  border:1px solid var(--stroke); padding:10px 14px; border-radius:12px; box-shadow:var(--shadow);
  opacity:0; transform:translateY(8px); transition:.25s; z-index:50;
}
.toast.show{opacity:1; transform:translateY(0)}
.spinner{
  position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.25); backdrop-filter:blur(2px); z-index:40;
}
.spinner.show{display:grid}
.spinner .dot{
  width:10px; height:10px; margin:0 4px; background:var(--accent); border-radius:50%;
  animation:bounce .8s infinite ease-in-out alternate;
}
.spinner .dot:nth-child(2){animation-delay:.15s} .spinner .dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{to{transform:translateY(-8px)}}

.topbar{
  position:sticky; top:0; z-index:30; display:flex; justify-content:flex-end; padding:8px 16px;
  backdrop-filter:blur(8px); background:linear-gradient(180deg, rgba(0,0,0,.45), transparent);
}
.switch{display:inline-flex; align-items:center; gap:8px; color:var(--muted); font-size:.9rem}
.switch input{width:auto}

.canvas-wrap{
  background:var(--panel); border:1px solid var(--stroke); border-radius:14px; padding:8px;
  box-shadow:var(--shadow);
}

.metrics{display:grid; grid-template-columns:repeat(6,minmax(0,1fr)); gap:10px; margin-top:10px}
@media (max-width:1024px){.metrics{grid-template-columns:repeat(2,minmax(0,1fr))}}
.metric{
  background:var(--panel); border:1px solid var(--stroke); border-radius:12px; padding:12px; text-align:center
}
.metric .label{color:var(--muted); font-size:.8rem}
.metric .value{font-size:1.06rem; font-weight:700; margin-top:4px}

.status{margin-top:8px; color:var(--muted); font-size:.9rem; min-height:1.4em}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <label class="switch">
      <input type="checkbox" id="themeToggle"> Tema claro
    </label>
  </div>
  <h1>üìà Simulador de Carteiras</h1>
  <p>Escolha ativos no cat√°logo ‚Üí ajuste pesos ‚Üí simule.</p>
</header>

<div class="container">
  <div class="grid">
    <!-- ESQUERDA: CONFIGURA√á√ÉO -->
    <div class="card">
      <h3>1) Adicionar ativos</h3>
      <p class="small">O cat√°logo abaixo j√° traz <b>retorno esperado (a.a. %)</b> e <b>vol 1y (a.a. %)</b> de exemplo. Voc√™ pode editar depois de adicionar.</p>
      <div class="row">
        <div style="grid-column: span 3;">
          <label>Cat√°logo de ativos</label>
          <select id="catalogSelect"></select>
        </div>
        <div style="display:flex;align-items:flex-end">
          <button class="btn" id="addAssetBtn">Adicionar ativo</button>
        </div>
      </div>

      <h3 style="margin-top:16px">2) Sua carteira</h3>
      <p class="small">Marque ‚ÄúUsar‚Äù para incluir na simula√ß√£o. Pesos s√£o normalizados automaticamente.</p>

      <div class="table-wrap">
        <table id="assetsTable" aria-label="Tabela de ativos">
          <colgroup>
            <col class="usar"><col class="ativo"><col class="ret">
            <col class="vol"><col class="peso"><col class="acoes">
          </colgroup>
          <thead>
            <tr>
              <th>Usar</th>
              <th>Ativo</th>
              <th>Ret. a.a. (%)</th>
              <th>Vol 1y a.a. (%)</th>
              <th>Peso (%)</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="assetsBody"></tbody>
        </table>
      </div>

      <h3 style="margin-top:16px">3) Par√¢metros</h3>
      <div class="row">
        <div><label>Horizonte (anos)</label><input id="years" type="number" value="10" step="0.1" min="0.0833"></div>
        <div><label>Caminhos (Monte Carlo)</label><input id="npaths" type="number" value="5000" step="100" min="10" max="50000"></div>
        <div><label>Correla√ß√£o m√©dia</label><input id="rho" type="number" value="0.2" step="0.05" min="-0.9" max="0.95"></div>
        <div><label>Risk-free a.a. (%)</label><input id="rf" type="number" value="6" step="0.1"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div><label>Seed</label><input id="seed" type="number" value="12345" step="1"></div>
        <div><label>Valor inicial (R$)</label><input id="S0" type="number" value="10000" step="100"></div>
        <div><label>Aporte mensal (R$)</label><input id="aport" type="number" value="0" step="50"></div>
        <div><label>IR sobre lucro (%)</label><input id="ir" type="number" value="0" step="0.5" min="0" max="30"></div>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn" id="runBtn">Simular</button>
          <button class="btn secondary" id="sampleBtn">Simular (r√°pido)</button>
        </div>
      </div>
      <div id="status" class="status" role="status" aria-live="polite"></div>
    </div>

    <!-- DIREITA: RESULTADOS -->
    <div class="card">
      <h3>Resultados</h3>
      <div class="metrics">
        <div class="metric"><div class="label">M√©dia final</div><div id="m_mean" class="value">‚Äî</div></div>
        <div class="metric"><div class="label">Mediana final</div><div id="m_median" class="value">‚Äî</div></div>
        <div class="metric"><div class="label">Lucro final (m√©dio)</div><div id="m_profit" class="value">‚Äî</div></div>
        <div class="metric"><div class="label">P5 / P95</div><div id="m_p" class="value">‚Äî</div></div>
        <div class="metric"><div class="label">Ret. a.a. / Vol a.a.</div><div id="m_rv" class="value">‚Äî</div></div>
        <div class="metric"><div class="label">Sharpe</div><div id="m_sharpe" class="value">‚Äî</div></div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:14px;margin-bottom:6px">
        <h4 style="margin:0">Caminhos simulados (carteira)</h4>
      </div>
      <div class="canvas-wrap">
        <canvas id="chartPaths" height="300" aria-label="Gr√°fico de caminhos" role="img"></canvas>
      </div>

      <h4 style="margin-top:14px">Distribui√ß√£o do valor final</h4>
      <div class="canvas-wrap">
        <canvas id="chartHist" height="220" aria-label="Histograma do valor final" role="img"></canvas>
      </div>

      <h4 style="margin-top:16px">Contribui√ß√£o m√©dia por ativo (valor final)</h4>
      <table id="byAsset">
        <thead><tr><th>Ativo</th><th>Peso</th><th>Ret. a.a. (%)</th><th>Vol a.a. (%)</th><th>Valor final m√©dio (R$)</th></tr></thead>
        <tbody id="byAssetBody"></tbody>
      </table>

      <p class="small" style="margin-top:8px">Prot√≥tipo educacional ‚Äî n√£o √© recomenda√ß√£o de investimento.</p>
    </div>
  </div>
</div>

<script>
/* ========= Helpers visuais ========= */
const root = document.documentElement;
document.getElementById("themeToggle")?.addEventListener("change", (e)=>{
  if(e.target.checked) root.setAttribute("data-theme","light");
  else root.removeAttribute("data-theme");
});
function toast(msg, ms=2400){
  const el = document.getElementById("toast");
  if(!el) return; el.textContent = msg; el.classList.add("show");
  setTimeout(()=> el.classList.remove("show"), ms);
}
function spin(on){
  const s = document.getElementById("spinner");
  if(!s) return; s.classList.toggle("show", !!on);
}

/* ========= Helpers ========= */
const $ = (id) => document.getElementById(id);
const fmtBR = (x) => x.toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

/* ========= Cat√°logo de ativos ========= */
const CATALOG = [
  {symbol:"PETR4 (A√ß√£o BR)",     exp_return_aa:12.0, vol_1y_aa:35.0},
  {symbol:"VALE3 (A√ß√£o BR)",     exp_return_aa:20.0, vol_1y_aa:40.0},
  {symbol:"BOVA11 (Ibovespa)",   exp_return_aa:10.0, vol_1y_aa:22.0},
  {symbol:"IVVB11 (S&P500 BRL)", exp_return_aa:9.0,  vol_1y_aa:18.0},
  {symbol:"KNCR11 (Kinea)",      exp_return_aa:14.0, vol_1y_aa:9.5},
  {symbol:"Bitcoin",             exp_return_aa:30.0, vol_1y_aa:50.0},
  {symbol:"Tesouro Selic",       exp_return_aa:12.0, vol_1y_aa:3.5},
  {symbol:"Tesouro IPCA+7",      exp_return_aa:10.6, vol_1y_aa:6.0},
  {symbol:"D√≥lar (USD/BRL)",     exp_return_aa:5.0,  vol_1y_aa:18.0},
];

/* ========= Estado da carteira ========= */
let assets = []; // {enabled, symbol, exp_return_aa, vol_1y_aa, weight}

/* ========= UI: cat√°logo e carteira ========= */
function renderCatalog(){
  const select = $("catalogSelect");
  select.innerHTML = "";
  CATALOG.forEach((a, idx)=>{
    const opt = document.createElement("option");
    opt.value = idx;
    opt.textContent = `${a.symbol} ‚Äî Ret ${a.exp_return_aa}% ‚Ä¢ Vol ${a.vol_1y_aa}%`;
    select.appendChild(opt);
  });
}

function renderAssets(){
  const tbody = $("assetsBody");
  tbody.innerHTML = "";
  assets.forEach((a,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <input type="checkbox" ${a.enabled?'checked':''} data-i="${i}" data-k="enabled">
      </td>
      <td>
        <input type="text" value="${a.symbol}" data-i="${i}" data-k="symbol" title="Nome do ativo">
      </td>
      <td>
        <input type="number" step="0.1" value="${a.exp_return_aa}"
               data-i="${i}" data-k="exp_return_aa" placeholder="%" title="Retorno a.a. (%)">
      </td>
      <td>
        <input type="number" step="0.1" value="${a.vol_1y_aa}"
               data-i="${i}" data-k="vol_1y_aa" placeholder="%" title="Volatilidade a.a. (%)">
      </td>
      <td>
        <input type="number" step="0.1" min="0" max="100"
               value="${(a.weight*100).toFixed(1)}"
               data-i="${i}" data-k="weight" placeholder="%" title="Peso da carteira (%)">
      </td>
      <td>
        <button class="iconbtn danger" data-i="${i}" data-action="remove">Remover</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* editar/remo√ß√£o */
$("assetsBody").addEventListener("input", (e)=>{
  const i = +e.target.dataset.i;
  const k = e.target.dataset.k;
  if (i == null || !k) return;

  if (k === "enabled"){
    assets[i].enabled = e.target.checked;
    normalizeWeights(); renderAssets();
    return;
  }
  if (k === "symbol"){
    assets[i].symbol = e.target.value; return;
  }

  const raw = parseFloat(e.target.value);
  if (k === "weight"){
    const pct = isFinite(raw) ? clamp(raw, 0, 100) : 0;
    assets[i].weight = pct / 100;  // UI em %, interno em fra√ß√£o
    return;
  }
  assets[i][k] = isFinite(raw) ? raw : 0; // ret/vol continuam em %
});

$("assetsBody").addEventListener("click", (e)=>{
  const act = e.target.dataset.action;
  if(act==="remove"){
    const i = +e.target.dataset.i;
    const removed = assets.splice(i,1)[0];
    normalizeWeights(); renderAssets();
    $("status").textContent = `Ativo "${removed.symbol}" removido.`;
  }
});
$("addAssetBtn").addEventListener("click", addSelectedAsset);

function addSelectedAsset(){
  const idx = parseInt($("catalogSelect").value);
  const item = CATALOG[idx];
  if(assets.some(a=>a.symbol===item.symbol)){
    $("status").textContent = "Esse ativo j√° est√° na carteira."; return;
  }
  assets.push({
    enabled:true,
    symbol:item.symbol,
    exp_return_aa:item.exp_return_aa,
    vol_1y_aa:item.vol_1y_aa,
    weight: assets.length? 0.0 : 1.0
  });
  normalizeWeights();
  renderAssets();
  $("status").textContent = `Ativo "${item.symbol}" adicionado.`;
}

function normalizeWeights(){
  const enabled = assets.filter(a=>a.enabled);
  if(enabled.length===0) return;
  const sum = enabled.reduce((s,a)=>s + (isFinite(a.weight)?a.weight:0), 0);
  if(sum <= 1e-9){
    const equal = 1/enabled.length;
    assets.forEach(a=>{ if(a.enabled) a.weight = equal; });
  } else {
    assets.forEach(a=>{ if(a.enabled) a.weight = a.weight / sum; });
  }
}

/* ========= Web Worker (Monte Carlo) ========= */
const workerCode = `
  const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
  function monthlyRateFromAnnual(pctAA){ return Math.pow(1 + pctAA/100, 1/12) - 1; }
  function monthlyVolFromAnnual(pctAA){ return (pctAA/100)/Math.sqrt(12); }
  function LCG(seed=12345){ let s = seed>>>0; return ()=>{ s = (1664525*s + 1013904223) >>> 0; return s / 4294967296; }; }
  function randn(rng){ const u1=Math.max(rng(),1e-12), u2=rng(); return Math.sqrt(-2*Math.log(u1))*Math.cos(2*Math.PI*u2); }
  function cholesky(A){
    const n=A.length; const L=Array.from({length:n},()=>Array(n).fill(0));
    for(let i=0;i<n;i++){
      for(let j=0;j<=i;j++){
        let sum = A[i][j];
        for(let k=0;k<j;k++) sum -= L[i][k]*L[j][k];
        if(i===j){ L[i][j] = Math.sqrt(Math.max(sum,1e-12)); }
        else { L[i][j] = sum / L[j][j]; }
      }
    }
    return L;
  }

  onmessage = (e)=>{
    const {assets, years, npaths, rho, rfAA, S0, aport, seed, samplePaths} = e.data;
    const sel = assets.filter(a=>a.enabled);
    const k = sel.length;
    if(k===0){ postMessage({error:"Nenhum ativo selecionado."}); return; }

    // normaliza pesos
    let wsum = sel.reduce((s,a)=>s + (isFinite(a.weight)?a.weight:0), 0);
    if(wsum<=0){ wsum = k; sel.forEach(a=>a.weight=1/k); } else sel.forEach(a=>a.weight=a.weight/wsum);

    // par√¢metros mensais
    const muM = sel.map(a=>monthlyRateFromAnnual(a.exp_return_aa));
    const sigM = sel.map(a=>monthlyVolFromAnnual(a.vol_1y_aa));
    const w = sel.map(a=>a.weight);

    // covari√¢ncia (mensal) + cholesky com jitter
    const C = Array.from({length:k},()=>Array(k).fill(0));
    for(let i=0;i<k;i++)for(let j=0;j<k;j++) C[i][j] = (i===j? sigM[i]*sigM[i] : rho*sigM[i]*sigM[j]);
    let jitter=1e-12; let L=null;
    while(true){
      try{
        const Cj = C.map((row,i)=>row.map((v,j)=> v + (i===j?jitter:0)));
        L = cholesky(Cj); break;
      }catch{ jitter*=10; if(jitter>1e-3){ postMessage({error:"Matriz de covari√¢ncia inv√°lida."}); return; } }
    }

    const months = Math.max(1, Math.round(years * 12));
    const rng = LCG(seed);

    const keep = Math.min(samplePaths, npaths);
    const xs = Array(months+1).fill(0).map((_,i)=>i);
    const sampled = Array.from({length:keep}, ()=> new Float64Array(months+1));
    for(let j=0;j<keep;j++) sampled[j][0] = S0;
    const finals = new Float64Array(npaths);
    const finalByAsset = new Float64Array(k);

    for(let p=0;p<npaths;p++){
      let S = w.map(wi=>S0*wi);
      for(let t=1;t<=months;t++){
        const u = Array.from({length:k},()=>randn(rng));
        const z = L.map(row=>row.reduce((s,v,idx)=>s+v*u[idx],0));
        for(let i=0;i<k;i++){
          const growth = Math.exp((muM[i] - 0.5*sigM[i]*sigM[i]) + sigM[i]*z[i]);
          S[i] *= growth;
        }
        if(aport>0) for(let i=0;i<k;i++) S[i] += aport*w[i];
        if(p<keep){
          const total = S.reduce((s,v)=>s+v,0);
          sampled[p][t] = total;
        }
      }
      finals[p] = S.reduce((s,v)=>s+v,0);
      for(let i=0;i<k;i++) finalByAsset[i]+=S[i];
    }
    for(let i=0;i<k;i++) finalByAsset[i]/=npaths;

    // ----- m√©tricas -----
    // distribui√ß√£o dos finais
    const mean = finals.reduce((s,v)=>s+v,0)/npaths;
    const sorted = Array.from(finals).sort((a,b)=>a-b);
    const median = sorted.length%2
      ? sorted[(sorted.length-1)/2]
      : (sorted[sorted.length/2-1] + sorted[sorted.length/2]) / 2;
    const p5  = sorted[Math.floor((sorted.length-1)*0.05)];
    const p95 = sorted[Math.floor((sorted.length-1)*0.95)];

    // Sharpe do modelo (coerente): retorno esperado mensal = w¬∑muM, var mensal = w·µÄ C w
    const mean_m_model = w.reduce((s, wi, i) => s + wi * muM[i], 0);

    let var_m_model = 0;
    for (let i = 0; i < w.length; i++) {
      for (let j = 0; j < w.length; j++) {
        var_m_model += w[i] * C[i][j] * w[j];
      }
    }
    var_m_model = Math.max(0, var_m_model);
    const std_m_model = Math.sqrt(var_m_model);

    const retAA = Math.pow(1 + mean_m_model, 12) - 1;
    const volAA = std_m_model * Math.sqrt(12);
    const sharpe = (retAA - rfAA) / (volAA + 1e-12);

    postMessage({ xs, sampled, finals, mean, median, p5, p95, retAA, volAA, sharpe, finalByAsset, assets: sel });
  };
`;
const worker = new Worker(URL.createObjectURL(new Blob([workerCode], {type: "text/javascript"})));

/* ========= Gr√°ficos ========= */
let pathsChart=null, histChart=null;
function drawCharts(xs, sampled, finals){
  const ctx1 = $("chartPaths").getContext("2d");
  if(pathsChart) pathsChart.destroy();

  const datasets=[];
  for(let j=0;j<sampled.length;j++){
    datasets.push({
      label: j===0 ? "Carteira" : undefined,
      data: Array.from(sampled[j]),
      pointRadius:0, borderWidth:1, tension:.12
    });
  }

  pathsChart = new Chart(ctx1, {
    type: "line",
    data: { labels: xs, datasets },
    options: {
      plugins: { legend: { display: false } },
      scales: { x: { title: { display: true, text: "M√™s" } },
                y: { title: { display: true, text: "Valor (R$)" } } }
    }
  });

  const ctx2 = $("chartHist").getContext("2d");
  if(histChart) histChart.destroy();
  const nbins=30; const min=Math.min(...finals), max=Math.max(...finals);
  const step=(max-min)/nbins || 1; const counts=new Array(nbins).fill(0), centers=[];
  for(let i=0;i<nbins;i++) centers.push((min+(i+0.5)*step).toFixed(0));
  for(const v of finals){ let idx=Math.floor((v-min)/step); if(idx===nbins) idx=nbins-1; counts[idx]++; }
  histChart = new Chart(ctx2, {
    type:"bar",
    data:{labels:centers, datasets:[{label:"Valor final (ap√≥s IR)", data:counts}]},
    options:{
      plugins:{legend:{display:false}},
      scales:{ x:{title:{display:true,text:"Valor final (faixa)"}},
               y:{title:{display:true,text:"Frequ√™ncia"}} }
    }
  });
}

/* ========= Simula√ß√£o ========= */
function captureParams(){
  return {
    years: clamp(parseFloat($("years").value) || 10, 0.0833, 100),
    npaths: clamp(parseInt($("npaths").value)||5000, 10, 50000),
    rho: clamp(parseFloat($("rho").value)||0.2, -0.9, 0.95),
    rf: parseFloat($("rf").value)||6,
    seed: parseInt($("seed").value)||12345,
    S0: parseFloat($("S0").value)||10000,
    aport: parseFloat($("aport").value)||0,
    ir: clamp(parseFloat($("ir").value)||0, 0, 100)
  };
}

function runSimulation(fast=false){
  const params = captureParams();
  const sel = assets.filter(a=>a.enabled);
  if(sel.length===0){ $("status").textContent="Selecione/adicione pelo menos um ativo."; return; }

  // normaliza pesos entre habilitados
  let sum = sel.reduce((s,a)=>s + (isFinite(a.weight)?a.weight:0), 0);
  if(sum<=0){ sel.forEach(a=>a.weight=1/sel.length); }
  else sel.forEach(a=>a.weight=a.weight/sum);

  // aplica pesos normalizados de volta
  assets = assets.map(a=>{
    const f = sel.find(s=>s.symbol===a.symbol);
    return f ? {...a, weight:f.weight} : a;
  });

  $("status").textContent = fast ? "Simulando (r√°pido)..." : "Simulando em segundo plano...";
  spin(true);
  const t0 = performance.now();

  worker.postMessage({
    assets: assets,
    years: params.years,
    npaths: fast ? Math.max(50, Math.floor(params.npaths/5)) : params.npaths,
    rho: params.rho,
    rfAA: params.rf/100,
    S0: params.S0,
    aport: params.aport,
    seed: params.seed,
    samplePaths: 60
  });

worker.onmessage = (ev)=>{
  spin(false);
  const t1 = performance.now();
  if(ev.data.error){ $("status").textContent = ev.data.error; toast(ev.data.error); return; }

  const { xs, sampled, finals, mean, median, p5, p95, retAA, volAA, sharpe, finalByAsset, assets: used } = ev.data;

  const params   = captureParams();
  const months   = params.years * 12;
  const invested = params.S0 + params.aport * months;
  const ir       = Math.max(0, params.ir) / 100;

  const finalsTaxed = new Float64Array(finals.length);
  for (let i = 0; i < finals.length; i++) {
    const v = finals[i];
    const profit = Math.max(0, v - invested);
    finalsTaxed[i] = invested + profit * (1 - ir);
  }

  const meanTax = finalsTaxed.reduce((s,v)=>s+v,0) / finalsTaxed.length;

  
  const profitMean = Math.max(0, meanTax - invested);

  const sortedTax = Array.from(finalsTaxed).sort((a,b)=>a-b);
  const medianTax = sortedTax.length % 2
    ? sortedTax[(sortedTax.length-1)/2]
    : (sortedTax[sortedTax.length/2-1] + sortedTax[sortedTax.length/2]) / 2;
  const p5Tax  = sortedTax[Math.floor((sortedTax.length-1)*0.05)];
  const p95Tax = sortedTax[Math.floor((sortedTax.length-1)*0.95)];

  const yearsEff  = Math.max(1, params.years);
  const retAA_eff = Math.pow(meanTax / Math.max(1, invested), 1/yearsEff) - 1;

  const sharpe_eff = (retAA_eff - params.rf/100) / (volAA + 1e-12);

  const scale = mean > 0 ? (meanTax / mean) : 1;
  const finalByAssetTax = Array.from(finalByAsset, v => v * scale);

  $("m_mean").textContent   = "R$ " + fmtBR(meanTax);
  $("m_profit").textContent = "R$ " + fmtBR(profitMean);
  $("m_median").textContent = "R$ " + fmtBR(medianTax);
  $("m_p").textContent      = `P5: R$ ${fmtBR(p5Tax)} | P95: R$ ${fmtBR(p95Tax)}`;
  $("m_rv").textContent     = `${(retAA_eff*100).toFixed(2)}% / ${(volAA*100).toFixed(2)}%`;
  $("m_sharpe").textContent = sharpe_eff.toFixed(2);

  const body = $("byAssetBody"); body.innerHTML = "";
  used.forEach((a,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${a.symbol}</td><td>${(a.weight*100).toFixed(1)}%</td>
                    <td>${(+a.exp_return_aa).toFixed(2)}</td><td>${(+a.vol_1y_aa).toFixed(2)}</td>
                    <td>R$ ${fmtBR(finalByAssetTax[i])}</td>`;
    body.appendChild(tr);
  });

  drawCharts(xs, sampled, finalsTaxed);

  $("status").textContent = `Pronto em ${(t1 - performance.now()).toFixed(0)} ms (${finals.length} caminhos). (IR aplicado)`;
  toast("Simula√ß√£o conclu√≠da (ap√≥s IR)");
};

}

/* ========= Boot ========= */
renderCatalog();
assets = [
  {enabled:true, symbol:CATALOG[2].symbol, exp_return_aa:CATALOG[2].exp_return_aa, vol_1y_aa:CATALOG[2].vol_1y_aa, weight:0.5},
  {enabled:true, symbol:CATALOG[6].symbol, exp_return_aa:CATALOG[6].exp_return_aa, vol_1y_aa:CATALOG[6].vol_1y_aa, weight:0.5},
];
renderAssets();
$("runBtn").addEventListener("click", ()=>runSimulation(false));
$("sampleBtn").addEventListener("click", ()=>runSimulation(true));
window.addEventListener("load", ()=> setTimeout(()=>runSimulation(true), 250));
</script>

<!-- UI do toast e spinner -->
<div class="toast" id="toast"></div>
<div class="spinner" id="spinner">
  <div class="dot"></div><div class="dot"></div><div class="dot"></div>
</div>
</body>
</html>
