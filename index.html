<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulador de Carteiras </title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<meta name="theme-color" content="#0b132b">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js" defer></script>
<style>
:root{
  --bg: #0b132b;
  --bg-2:#0e1b39;
  --panel:#0f1f3f;
  --stroke:#223a6a;
  --accent:#00c853;
  --accent-2:#43d38e;
  --text:#eef3ff;
  --muted:#a9bbd8;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
}
[data-theme="light"]{
  --bg:#f6f8fc; --bg-2:#ffffff; --panel:#ffffff; --stroke:#dfe7f3;
  --text:#0e1b2b; --muted:#5a6d86; --shadow:0 8px 24px rgba(16,44,84,.10);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:radial-gradient(1200px 800px at 20% -10%, #13305f 0%, var(--bg) 55%) no-repeat fixed;
  color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial;
}
header{
@@ -429,68 +428,66 @@ const workerCode = `
    for(let i=0;i<k;i++) finalByAsset[i]/=npaths;

    // métricas (estimadas pela primeira amostra de caminhos para retornos mensais)
    const rets = [];
    for(let t=1;t<=months;t++){
      const prev = sampled[0][t-1], cur = sampled[0][t];
      if(prev>0) rets.push(cur/prev - 1);
    }
    const mean = finals.reduce((s,v)=>s+v,0)/npaths;
    const sorted = Array.from(finals).sort((a,b)=>a-b);
    const median = sorted.length%2? sorted[(sorted.length-1)/2] : (sorted[sorted.length/2-1]+sorted[sorted.length/2])/2;
    const p5 = sorted[Math.floor((sorted.length-1)*0.05)];
    const p95 = sorted[Math.floor((sorted.length-1)*0.95)];
    const mean_m = rets.reduce((s,v)=>s+v,0)/rets.length;
    const var_m = rets.reduce((s,v)=>s+(v-mean_m)*(v-mean_m),0)/rets.length;
    const std_m = Math.sqrt(Math.max(0,var_m));
    const retAA = Math.pow(1+mean_m,12)-1;
    const volAA = std_m*Math.sqrt(12);
    const sharpe = (retAA - rfAA) / (volAA + 1e-12);

    postMessage({ xs, sampled, finals, mean, median, p5, p95, retAA, volAA, sharpe, finalByAsset, assets: sel });
  };
`;
const worker = new Worker(URL.createObjectURL(new Blob([workerCode], {type: "text/javascript"})));

document.addEventListener("DOMContentLoaded", () => {
  if (window.Chart && window.ChartZoom) {
    Chart.register(window.ChartZoom);
  }
});


/* ========= Gráficos ========= */
let pathsChart=null, histChart=null;
function drawCharts(xs, sampled, finals){
  const ctx1 = $("chartPaths").getContext("2d");
  if(pathsChart) pathsChart.destroy();
  const datasets = [];
  for(let j=0;j<sampled.length;j++){
    datasets.push({ label: j===0 ? "Carteira" : undefined, data: Array.from(sampled[j]), pointRadius:0, borderWidth:1, tension:.12 });
  }
  pathsChart = new Chart(ctx1, {
  type: "line",
  data: { labels: xs, datasets },
  options: {
    plugins: {
      legend: { display:false },
      zoom: {
        zoom: {
          wheel: { enabled: true },
          pinch: { enabled: true },
          drag:  { enabled: true },
          mode: "xy"   
        },
        pan: {
          enabled: true,
          mode: "xy",
          modifierKey: "shift" 
        },
        limits: {
          x: { min: "original", max: "original" },
          y: { min: "original", max: "original" }
        }
      }
    },
    scales: {
@@ -517,126 +514,105 @@ function captureParams(){
    npaths: clamp(parseInt($("npaths").value)||5000, 10, 50000),
    rho: clamp(parseFloat($("rho").value)||0.2, -0.9, 0.95),
    rf: parseFloat($("rf").value)||6,
    seed: parseInt($("seed").value)||12345,
    S0: parseFloat($("S0").value)||10000,
    aport: parseFloat($("aport").value)||0
  };
}
function runSimulation(fast=false){
  const params = captureParams();
  const sel = assets.filter(a=>a.enabled);
  if(sel.length===0){ $("status").textContent="Selecione/adicione pelo menos um ativo."; return; }

  // normaliza pesos entre ativos habilitados
  let sum = sel.reduce((s,a)=>s + (isFinite(a.weight)?a.weight:0), 0);
  if(sum<=0){ sel.forEach(a=>a.weight=1/sel.length); }
  else sel.forEach(a=>a.weight=a.weight/sum);

  // aplica pesos normalizados de volta
  assets = assets.map(a=>{
    const f = sel.find(s=>s.symbol===a.symbol);
    return f ? {...a, weight:f.weight} : a;
  });

  // status + spinner + carimbo de tempo
  $("status").textContent = fast ? "Simulando (rápido)..." : "Simulando em segundo plano...";
  spin(true);
  const t0 = performance.now();

  // manda a simulação pro worker (mesmo payload que você já tinha)
  worker.postMessage({
    assets: assets,
    years: params.years,
    npaths: fast ? Math.max(50, Math.floor(params.npaths/5)) : params.npaths,
    rho: params.rho,
    rfAA: params.rf/100,
    S0: params.S0,
    aport: params.aport,
    seed: params.seed,
    samplePaths: 60
  });

  // recebe o resultado
  worker.onmessage = (ev)=>{
    spin(false);
    const t1 = performance.now();

    if (ev.data.error){
      $("status").textContent = ev.data.error;
      toast(ev.data.error);
      return;
    }

    const {
      xs, sampled, finals,
      mean, median, p5, p95,
      retAA, volAA, sharpe,
      finalByAsset, assets: used
    } = ev.data;

    $("m_mean").textContent   = "R$ " + fmtBR(mean);
    $("m_median").textContent = "R$ " + fmtBR(median);
    $("m_p").textContent      = `P5: R$ ${fmtBR(p5)} | P95: R$ ${fmtBR(p95)}`;
    $("m_rv").textContent     = `${(retAA*100).toFixed(2)}% / ${(volAA*100).toFixed(2)}%`;
    $("m_sharpe").textContent = sharpe.toFixed(2);

    const body = $("byAssetBody");
    body.innerHTML = "";
    used.forEach((a,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${a.symbol}</td><td>${(a.weight*100).toFixed(1)}%</td>`
                    <td>${(+a.exp_return_aa).toFixed(2)}</td><td>${(+a.vol_1y_aa).toFixed(2)}</td>`
                    <td>R$ ${fmtBR(finalByAsset[i])}</td>`;
      body.appendChild(tr);
    });

    drawCharts(xs, sampled, finals);

    $("status").textContent = `Pronto em ${(t1 - t0).toFixed(0)} ms (${finals.length} caminhos).`;
    toast("Simulação concluída");
  };
}

document.getElementById("resetZoomPaths")?.addEventListener("click", () => {
  if (pathsChart && pathsChart.resetZoom) {
    pathsChart.resetZoom();
  }
});
  
/* ========= Boot ========= */
renderCatalog();
// carteira demo inicial (dois ativos do catálogo)
assets = [
  {enabled:true,  symbol:CATALOG[2].symbol, exp_return_aa:CATALOG[2].exp_return_aa, vol_1y_aa:CATALOG[2].vol_1y_aa, weight:0.5},
  {enabled:true,  symbol:CATALOG[6].symbol, exp_return_aa:CATALOG[6].exp_return_aa, vol_1y_aa:CATALOG[6].vol_1y_aa, weight:0.5},
];
renderAssets();
$("runBtn").addEventListener("click", ()=>runSimulation(false));
$("sampleBtn").addEventListener("click", ()=>runSimulation(true));
window.addEventListener("load", ()=> setTimeout(()=>runSimulation(true), 250));
</script>
<div class="toast" id="toast"></div>
<div class="spinner" id="spinner">
  <div class="dot"></div><div class="dot"></div><div class="dot"></div>
</div>
