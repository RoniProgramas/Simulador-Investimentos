<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulador de Carteiras</title>

<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<meta name="theme-color" content="#0b132b">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#0b132b; --bg-2:#0e1b39; --panel:#0f1f3f; --stroke:#223a6a;
  --accent:#00c853; --accent-2:#43d38e;
  --text:#eef3ff; --muted:#a9bbd8; --shadow:0 10px 30px rgba(0,0,0,.35);
}
[data-theme="light"]{
  --bg:#f6f8fc; --bg-2:#ffffff; --panel:#ffffff; --stroke:#dfe7f3;
  --text:#0e1b2b; --muted:#5a6d86; --shadow:0 8px 24px rgba(16,44,84,.10);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:radial-gradient(1200px 800px at 20% -10%, #13305f 0%, var(--bg) 55%) no-repeat fixed;
  color:var(--text); font-family:Inter, system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
}
header{
  padding:24px 16px; text-align:center; border-bottom:1px solid var(--stroke);
  background:linear-gradient(180deg, rgba(255,255,255,.04), transparent);
}
header h1{margin:0; font-size:1.75rem; letter-spacing:.2px}
header p{margin:.5rem auto 0; color:var(--muted); max-width:920px}

.container{max-width:1400px; margin:18px auto; padding:0 16px}


.grid{
  display:grid;
  grid-template-columns: minmax(0,1fr) minmax(0,1fr);
  gap:16px;
}
.grid > .card{ min-width:0; } 
@media (max-width:1100px){ .grid{ grid-template-columns:1fr } }

.card{
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
  border:1px solid var(--stroke); border-radius:16px; padding:16px;
  box-shadow:var(--shadow); backdrop-filter:blur(6px);
}
h3{margin:0 0 8px 0; font-size:1.05rem}
h4{margin:0 0 10px 0}
.small{font-size:.9rem; color:var(--muted)}

.row{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:12px}
@media (max-width:1024px){.row{grid-template-columns:repeat(2,minmax(0,1fr))}}

label{display:block; font-size:.85rem; color:var(--muted); margin:0 0 6px 6px}
input, select{
  width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--stroke);
  background:var(--panel); color:var(--text); outline:none; transition:.15s border, .15s box-shadow;
}
input:focus, select:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(0,200,83,.15)}

table{width:100%; border-collapse:separate; border-spacing:0 8px; margin-top:8px}
th, td{padding:10px 12px; font-size:.92rem}
thead th{color:var(--muted); font-weight:600}
tbody tr{
  background:var(--panel); border:1px solid var(--stroke);
  box-shadow:var(--shadow); border-radius:12px;
}
tbody td:first-child{border-top-left-radius:12px; border-bottom-left-radius:12px}
tbody td:last-child{border-top-right-radius:12px; border-bottom-right-radius:12px}
tbody td{border-top:1px solid var(--stroke); border-bottom:1px solid var(--stroke)}
tbody td+td{border-left:1px solid var(--stroke)}

.btn{
  display:inline-flex; align-items:center; gap:8px; border:0; cursor:pointer;
  background:var(--accent); color:#072716; font-weight:700; padding:10px 14px; border-radius:12px;
  transition:transform .05s ease, box-shadow .2s ease;
}
.btn:hover{box-shadow:0 6px 18px rgba(0,200,83,.25)}
.btn:active{transform:translateY(1px)}
.btn.secondary{background:transparent; color:var(--text); border:1px solid var(--stroke)}
.iconbtn{background:#11254b; border:1px solid #2a4275; color:#e7eeff; border-radius:8px; padding:6px 10px; cursor:pointer}
.iconbtn.danger{background:#4b1120; border-color:#7a2840}

.canvas-wrap{
  background:var(--panel); border:1px solid var(--stroke); border-radius:14px; padding:8px;
  box-shadow:var(--shadow);
}

.metrics{display:grid; grid-template-columns:repeat(5,minmax(0,1fr)); gap:10px; margin-top:10px}
@media (max-width:1024px){.metrics{grid-template-columns:repeat(2,minmax(0,1fr))}}
.metric{
  background:var(--panel); border:1px solid var(--stroke); border-radius:12px; padding:12px; text-align:center
}
.metric .label{color:var(--muted); font-size:.8rem}
.metric .value{font-size:1.06rem; font-weight:700; margin-top:4px}

.status{margin-top:8px; color:var(--muted); font-size:.9rem; min-height:1.4em}


.table-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
#assetsTable{ width:100%; table-layout:fixed; }
#assetsTable col.usar  { width:64px; }
#assetsTable col.ativo { width:240px; }
#assetsTable col.ret   { width:100px; }
#assetsTable col.vol   { width:100px; }
#assetsTable col.peso  { width:96px; }
#assetsTable col.acoes { width:110px; }

#assetsTable td input[type="text"],
#assetsTable td input[type="number"]{
  width:100%; display:block; font-size:1rem; padding:10px 12px; height:42px;
  border-radius:12px; background:var(--panel); color:var(--text); caret-color:var(--text);
}
#assetsTable td input[type="number"]{ text-align:right; font-variant-numeric:tabular-nums; }
#assetsTable td input[type="checkbox"]{ width:auto; height:18px; }
.input-sfx{ position:relative; }
.input-sfx input{ padding-right:28px; }
.input-sfx::after{
  content: attr(data-sfx);
  position:absolute; right:10px; top:50%; transform:translateY(-50%);
  color:var(--muted); font-size:.9rem; pointer-events:none;
}


.chart-toolbar .btn{ padding:8px 10px; font-weight:600; }
.chart-toolbar .btn + .btn{ margin-left:6px; }


.toast{
  position:fixed; right:18px; bottom:18px; background:var(--panel); color:var(--text);
  border:1px solid var(--stroke); padding:10px 14px; border-radius:12px; box-shadow:var(--shadow);
  opacity:0; transform:translateY(8px); transition:.25s; z-index:50;
}
.toast.show{opacity:1; transform:translateY(0)}
.spinner{
  position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.25); backdrop-filter:blur(2px); z-index:40;
}
.spinner.show{display:grid}
.spinner .dot{
  width:10px; height:10px; margin:0 4px; background:var(--accent); border-radius:50%;
  animation:bounce .8s infinite ease-in-out alternate;
}
.spinner .dot:nth-child(2){animation-delay:.15s} .spinner .dot:nth-child(3){animation-delay:.3s}
@keyframes bounce{to{transform:translateY(-8px)}}
</style>
</head>
<body>
<header>
  <h1>üìà Simulador de Carteiras</h1>
  <p>Escolha ativos no cat√°logo ‚Üí ajuste pesos ‚Üí simule.</p>
</header>

<div class="container">
  <div class="grid">
    <!-- ESQUERDA -->
    <div class="card">
      <h3>1) Adicionar ativos</h3>
      <p class="small">O cat√°logo abaixo j√° traz <b>retorno esperado (a.a. %)</b> e <b>vol 1y (a.a. %)</b> de exemplo. Voc√™ pode editar depois de adicionar.</p>
      <div class="row">
        <div style="grid-column: span 3;">
          <label>Cat√°logo de ativos</label>
          <select id="catalogSelect"></select>
        </div>
        <div style="display:flex;align-items:flex-end">
          <button class="btn" id="addAssetBtn">Adicionar ativo</button>
        </div>
      </div>

      <h3 style="margin-top:16px">2) Sua carteira</h3>
      <p class="small">Marque ‚ÄúUsar‚Äù para incluir na simula√ß√£o. Pesos s√£o normalizados automaticamente.</p>

      <div class="table-wrap">
        <table id="assetsTable" aria-label="Tabela de ativos">
          <colgroup>
            <col class="usar"><col class="ativo"><col class="ret"><col class="vol"><col class="peso"><col class="acoes">
          </colgroup>
          <thead>
            <tr>
              <th>Usar</th><th>Ativo</th><th>Ret. a.a. (%)</th><th>Vol 1y a.a. (%)</th><th>Peso (%)</th><th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="assetsBody"></tbody>
        </table>
      </div>

      <h3 style="margin-top:16px">3) Par√¢metros</h3>
      <div class="row">
        <div><label>Horizonte (anos)</label><input id="years" type="number" value="10" step="1" min="1"></div>
        <div><label>Caminhos (Monte Carlo)</label><input id="npaths" type="number" value="5000" step="100" min="10" max="50000"></div>
        <div><label>Correla√ß√£o m√©dia</label><input id="rho" type="number" value="0.2" step="0.05" min="-0.9" max="0.95"></div>
        <div><label>Risk-free a.a. (%)</label><input id="rf" type="number" value="6" step="0.1"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <div><label>Seed</label><input id="seed" type="number" value="12345" step="1"></div>
        <div><label>Valor inicial (R$)</label><input id="S0" type="number" value="10000" step="100"></div>
        <div><label>Aporte mensal (R$)</label><input id="aport" type="number" value="0" step="50"></div>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button class="btn" id="runBtn">Simular</button>
          <button class="btn secondary" id="sampleBtn">Simular (r√°pido)</button>
        </div>
      </div>
      <div id="status" class="status" role="status" aria-live="polite"></div>
    </div>

    <!-- DIREITA -->
    <div class="card">
      <h3>Resultados</h3>
      <div class="metrics">
        <div class="metric"><div class="label">M√©dia final</div><div id="m_mean" class="value">‚Äî</div></div>
        <div class="metric"><div class="label">Mediana final</div><div id="m_median" class="value">‚Äî</div></div>
        <div class="metric"><div class="label">P5 / P95</div><div id="m_p" class="value">‚Äî</div></div>
        <div class="metric"><div class="label">Ret. a.a. / Vol a.a.</div><div id="m_rv" class="value">‚Äî</div></div>
        <div class="metric"><div class="label">Sharpe (aprox.)</div><div id="m_sharpe" class="value">‚Äî</div></div>
      </div>

      
      <div style="display:flex;align-items:center;gap:8px;margin-top:14px;margin-bottom:6px">
        <h4 style="margin:0">Caminhos simulados (carteira)</h4>
        <div class="chart-toolbar" style="margin-left:auto">
          <button class="btn secondary" id="zoomIn"   type="button">+ Zoom</button>
          <button class="btn secondary" id="zoomOut"  type="button">‚àí Zoom</button>
          <button class="btn secondary" id="panLeft"  type="button">‚Üê</button>
          <button class="btn secondary" id="panRight" type="button">‚Üí</button>
          <button class="btn secondary" id="fit"      type="button">Ajustar</button>
          <button class="btn secondary" id="resetZoomPaths" type="button">Resetar</button>
        </div>
      </div>
      <div class="canvas-wrap">
        <canvas id="chartPaths" height="300" aria-label="Gr√°fico de caminhos" role="img"></canvas>
      </div>

      <h4 style="margin-top:14px">Distribui√ß√£o do valor final</h4>
      <div class="canvas-wrap">
        <canvas id="chartHist" height="220" aria-label="Histograma do valor final" role="img"></canvas>
      </div>

      <h4 style="margin-top:16px">Contribui√ß√£o m√©dia por ativo (valor final)</h4>
      <table id="byAsset">
        <thead><tr><th>Ativo</th><th>Peso</th><th>Ret. a.a. (%)</th><th>Vol a.a. (%)</th><th>Valor final m√©dio (R$)</th></tr></thead>
        <tbody id="byAssetBody"></tbody>
      </table>

      <p class="small" style="margin-top:8px">Prot√≥tipo educacional ‚Äî n√£o √© recomenda√ß√£o de investimento.</p>
    </div>
  </div>
</div>

<script>

function toast(msg, ms=2400){
  const el = document.getElementById("toast");
  if(!el) return; el.textContent = msg; el.classList.add("show");
  setTimeout(()=> el.classList.remove("show"), ms);
}
function spin(on){
  const s = document.getElementById("spinner");
  if(!s) return; s.classList.toggle("show", !!on);
}


const $ = (id) => document.getElementById(id);
const fmtBR = (x) => x.toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));

/* ===== cat√°logo de ativos ===== */
const CATALOG = [
  {symbol:"PETR4 (A√ß√£o BR)",     exp_return_aa:12.0, vol_1y_aa:35.0},
  {symbol:"VALE3 (A√ß√£o BR)",     exp_return_aa:11.0, vol_1y_aa:30.0},
  {symbol:"BOVA11 (Ibovespa)",   exp_return_aa:10.0, vol_1y_aa:22.0},
  {symbol:"IVVB11 (S&P500 BRL)", exp_return_aa:9.0,  vol_1y_aa:18.0},
  {symbol:"FII Setorial",        exp_return_aa:8.0,  vol_1y_aa:15.0},
  {symbol:"Cripto (BTC proxy)",  exp_return_aa:25.0, vol_1y_aa:80.0},
  {symbol:"Tesouro Selic",       exp_return_aa:6.0,  vol_1y_aa:3.5},
  {symbol:"Tesouro IPCA+",       exp_return_aa:7.5,  vol_1y_aa:6.0},
  {symbol:"D√≥lar (USD/BRL)",     exp_return_aa:5.0,  vol_1y_aa:18.0},
];

/* ===== estado ===== */
let assets = []; // {enabled, symbol, exp_return_aa, vol_1y_aa, weight}

/* ===== UI cat√°logo/carteira ===== */
function renderCatalog(){
  const select = $("catalogSelect");
  select.innerHTML = "";
  CATALOG.forEach((a, idx)=>{
    const opt = document.createElement("option");
    opt.value = idx;
    opt.textContent = `${a.symbol} ‚Äî Ret ${a.exp_return_aa}% ‚Ä¢ Vol ${a.vol_1y_aa}%`;
    select.appendChild(opt);
  });
  if (select.options.length > 0) select.selectedIndex = 0;
}
function renderAssets(){
  const tbody = $("assetsBody");
  tbody.innerHTML = "";
  assets.forEach((a,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input type="checkbox" ${a.enabled?'checked':''} data-i="${i}" data-k="enabled"></td>
      <td><input value="${a.symbol}" data-i="${i}" data-k="symbol" title="Nome do ativo"></td>
      <td><div class="input-sfx" data-sfx="%"><input type="number" step="0.1" value="${a.exp_return_aa}" data-i="${i}" data-k="exp_return_aa" title="Retorno esperado anual (%)"></div></td>
      <td><div class="input-sfx" data-sfx="%"><input type="number" step="0.1" value="${a.vol_1y_aa}" data-i="${i}" data-k="vol_1y_aa" title="Volatilidade 1 ano (anualizada, %)"></div></td>
      <td><div class="input-sfx" data-sfx="%"><input type="number" step="0.1" min="0" max="100" value="${(a.weight*100).toFixed(1)}" data-i="${i}" data-k="weight" title="Peso da carteira em %"></div></td>
      <td><button class="iconbtn danger" data-i="${i}" data-action="remove">Remover</button></td>
    `;
    tbody.appendChild(tr);
  });
}
function addSelectedAsset(){
  const sel = $("catalogSelect");
  if (!sel || sel.options.length === 0){ $("status").textContent = "Cat√°logo vazio."; return; }
  if (sel.selectedIndex < 0) sel.selectedIndex = 0;
  const idx = Number.parseInt(sel.value);
  const safeIdx = Number.isFinite(idx) ? idx : 0;
  const item = CATALOG[safeIdx];
  if(!item){ $("status").textContent = "Ativo inv√°lido."; return; }
  if(assets.some(a => a.symbol === item.symbol)){
    $("status").textContent = "Esse ativo j√° est√° na carteira."; return;
  }
  assets.push({ enabled:true, symbol:item.symbol, exp_return_aa:item.exp_return_aa, vol_1y_aa:item.vol_1y_aa, weight: assets.length? 0.0 : 1.0 });
  normalizeWeights(); renderAssets();
  $("status").textContent = `Ativo "${item.symbol}" adicionado.`;
}
function normalizeWeights(){
  const enabled = assets.filter(a=>a.enabled);
  if(enabled.length===0) return;
  const equal = 1/enabled.length;
  let sum = enabled.reduce((s,a)=>s+a.weight,0);
  if(sum <= 1e-9){ assets.forEach(a=>{ if(a.enabled) a.weight = equal; }); }
  else { assets.forEach(a=>{ if(a.enabled) a.weight = a.weight / sum; }); }
}
$("assetsBody").addEventListener("input", (e)=>{
  const i = +e.target.dataset.i;
  const k = e.target.dataset.k;
  if (i == null || !k) return;
  if (k === "enabled"){ assets[i].enabled = e.target.checked; normalizeWeights(); renderAssets(); return; }
  if (k === "symbol"){ assets[i].symbol = e.target.value; return; }
  const raw = parseFloat(e.target.value);
  if (k === "weight"){ const pct = isFinite(raw) ? clamp(raw, 0, 100) : 0; assets[i].weight = pct / 100; return; }
  assets[i][k] = isFinite(raw) ? raw : 0;
});
$("assetsBody").addEventListener("click", (e)=>{
  const act = e.target.dataset.action;
  if(act==="remove"){
    const i = +e.target.dataset.i;
    const removed = assets.splice(i,1)[0];
    normalizeWeights(); renderAssets();
    $("status").textContent = `Ativo "${removed.symbol}" removido.`;
  }
});
$("addAssetBtn").addEventListener("click", addSelectedAsset);

/* ===== Worker Monte Carlo ===== */
const workerCode = `
  const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
  function monthlyRateFromAnnual(pctAA){ return Math.pow(1 + pctAA/100, 1/12) - 1; }
  function monthlyVolFromAnnual(pctAA){ return (pctAA/100)/Math.sqrt(12); }
  function LCG(seed=12345){ let s = seed>>>0; return ()=>{ s = (1664525*s + 1013904223) >>> 0; return s / 4294967296; }; }
  function randn(rng){ const u1=Math.max(rng(),1e-12), u2=rng(); return Math.sqrt(-2*Math.log(u1))*Math.cos(2*Math.PI*u2); }
  function cholesky(A){
    const n=A.length; const L=Array.from({length:n},()=>Array(n).fill(0));
    for(let i=0;i<n;i++){
      for(let j=0;j<=i;j++){
        let sum = A[i][j];
        for(let k=0;k<j;k++) sum -= L[i][k]*L[j][k];
        if(i===j){ L[i][j] = Math.sqrt(Math.max(sum,1e-12)); }
        else { L[i][j] = sum / L[j][j]; }
      }
    }
    return L;
  }
  onmessage = (e)=>{
    const {assets, years, npaths, rho, rfAA, S0, aport, seed, samplePaths} = e.data;
    const sel = assets.filter(a=>a.enabled);
    const k = sel.length;
    if(k===0){ postMessage({error:"Nenhum ativo selecionado."}); return; }
    let wsum = sel.reduce((s,a)=>s + (isFinite(a.weight)?a.weight:0), 0);
    if(wsum<=0){ wsum = k; sel.forEach(a=>a.weight=1/k); } else sel.forEach(a=>a.weight=a.weight/wsum);
    const muM = sel.map(a=>monthlyRateFromAnnual(a.exp_return_aa));
    const sigM = sel.map(a=>monthlyVolFromAnnual(a.vol_1y_aa));
    const w = sel.map(a=>a.weight);
    const C = Array.from({length:k},()=>Array(k).fill(0));
    for(let i=0;i<k;i++)for(let j=0;j<k;j++) C[i][j] = (i===j? sigM[i]*sigM[i] : rho*sigM[i]*sigM[j]);
    let jitter=1e-12; let L=null;
    while(true){
      try{
        const Cj = C.map((row,i)=>row.map((v,j)=> v + (i===j?jitter:0)));
        L = cholesky(Cj); break;
      }catch{ jitter*=10; if(jitter>1e-3){ postMessage({error:"Matriz de covari√¢ncia inv√°lida."}); return; } }
    }
    const months = years*12;
    const rng = LCG(seed);
    const keep = Math.min(samplePaths, npaths);
    const xs = Array(months+1).fill(0).map((_,i)=>i);
    const sampled = Array.from({length:keep}, ()=> new Float64Array(months+1));
    for(let j=0;j<keep;j++) sampled[j][0] = S0;
    const finals = new Float64Array(npaths);
    const finalByAsset = new Float64Array(k);
    for(let p=0;p<npaths;p++){
      let S = w.map(wi=>S0*wi);
      for(let t=1;t<=months;t++){
        const u = Array.from({length:k},()=>randn(rng));
        const z = L.map(row=>row.reduce((s,v,idx)=>s+v*u[idx],0));
        for(let i=0;i<k;i++){
          const growth = Math.exp((muM[i] - 0.5*sigM[i]*sigM[i]) + sigM[i]*z[i]);
          S[i] *= growth;
        }
        if(aport>0) for(let i=0;i<k;i++) S[i] += aport*w[i];
        if(p<keep){
          const total = S.reduce((s,v)=>s+v,0);
          sampled[p][t] = total;
        }
      }
      finals[p] = S.reduce((s,v)=>s+v,0);
      for(let i=0;i<k;i++) finalByAsset[i]+=S[i];
    }
    for(let i=0;i<k;i++) finalByAsset[i]/=npaths;
    const rets = [];
    for(let t=1;t<=months;t++){
      const prev = sampled[0][t-1], cur = sampled[0][t];
      if(prev>0) rets.push(cur/prev - 1);
    }
    const mean = finals.reduce((s,v)=>s+v,0)/npaths;
    const sorted = Array.from(finals).sort((a,b)=>a-b);
    const median = sorted.length%2? sorted[(sorted.length-1)/2] : (sorted[sorted.length/2-1]+sorted[sorted.length/2])/2;
    const p5 = sorted[Math.floor((sorted.length-1)*0.05)];
    const p95 = sorted[Math.floor((sorted.length-1)*0.95)];
    const mean_m = rets.reduce((s,v)=>s+v,0)/rets.length;
    const var_m = rets.reduce((s,v)=>s+(v-mean_m)*(v-mean_m),0)/rets.length;
    const std_m = Math.sqrt(Math.max(0,var_m));
    const retAA = Math.pow(1+mean_m,12)-1;
    const volAA = std_m*Math.sqrt(12);
    const sharpe = (retAA - rfAA) / (volAA + 1e-12);
    postMessage({ xs, sampled, finals, mean, median, p5, p95, retAA, volAA, sharpe, finalByAsset, assets: sel });
  };
`;
const worker = new Worker(URL.createObjectURL(new Blob([workerCode], {type: "text/javascript"})));

/* ===== Gr√°ficos + zoom por bot√µes ===== */
let pathsChart=null, histChart=null;
let view=null, baseRange=null; // janela atual e limites base

function drawCharts(xs, sampled, finals){
  // PATHS
  const ctx1 = $("chartPaths").getContext("2d");
  if(pathsChart) pathsChart.destroy();

  const datasets=[];
  for(let j=0;j<sampled.length;j++){
    datasets.push({ label: j===0 ? "Carteira" : undefined, data: Array.from(sampled[j]), pointRadius:0, borderWidth:1, tension:.12 });
  }

  // limites base
  let yMin = Infinity, yMax = -Infinity;
  for (let j=0;j<sampled.length;j++){
    const arr = sampled[j];
    for (let t=0;t<arr.length;t++){
      const v = arr[t];
      if (v<yMin) yMin=v;
      if (v>yMax) yMax=v;
    }
  }
  const padY = (yMax - yMin) * 0.05 || 1;
  baseRange = { xMin:0, xMax: xs.length-1, yMin: Math.max(0, yMin - padY), yMax: yMax + padY };
  view = { ...baseRange };

  pathsChart = new Chart(ctx1, {
    type:"line",
    data:{ labels: xs, datasets },
    options:{
      plugins:{ legend:{ display:false } },
      scales:{
        x:{ title:{ display:true, text:"M√™s" }, min: view.xMin, max: view.xMax },
        y:{ title:{ display:true, text:"Valor (R$)" }, min: view.yMin, max: view.yMax }
      }
    }
  });

  // HIST
  const ctx2 = $("chartHist").getContext("2d");
  if(histChart) histChart.destroy();
  const nbins=30; const min=Math.min(...finals), max=Math.max(...finals);
  const step=(max-min)/nbins || 1; const counts=new Array(nbins).fill(0), centers=[];
  for(let i=0;i<nbins;i++) centers.push((min+(i+0.5)*step).toFixed(0));
  for(const v of finals){ let idx=Math.floor((v-min)/step); if(idx===nbins) idx=nbins-1; counts[idx]++; }
  histChart = new Chart(ctx2, { type:"bar", data:{labels:centers, datasets:[{label:"Valor final", data:counts}]},
    options:{ plugins:{legend:{display:false}}, scales:{x:{title:{display:true,text:"Valor final (faixa)"}}, y:{title:{display:true,text:"Frequ√™ncia"}} } });
}

function applyView(){
  if(!pathsChart || !view) return;
  pathsChart.options.scales.x.min = view.xMin;
  pathsChart.options.scales.x.max = view.xMax;
  pathsChart.options.scales.y.min = view.yMin;
  pathsChart.options.scales.y.max = view.yMax;
  pathsChart.update('none');
}
function clampView(){
  if(!baseRange || !view) return;
  const xSpan = view.xMax - view.xMin;
  const ySpan = view.yMax - view.yMin;
  if (xSpan <= 1) { view.xMin = Math.max(baseRange.xMin, view.xMin - 0.5); view.xMax = Math.min(baseRange.xMax, view.xMax + 0.5); }
  if (ySpan <= 1e-6) { view.yMin = baseRange.yMin; view.yMax = baseRange.yMax; }
  if (view.xMin < baseRange.xMin){ view.xMax += (baseRange.xMin - view.xMin); view.xMin = baseRange.xMin; }
  if (view.xMax > baseRange.xMax){ view.xMin -= (view.xMax - baseRange.xMax); view.xMax = baseRange.xMax; }
  if (view.yMin < baseRange.yMin){ view.yMin = baseRange.yMin; }
  if (view.yMax > baseRange.yMax){ view.yMax = baseRange.yMax; }
}
function zoomIn(f=0.8){
  if(!view) return;
  const cx = (view.xMin + view.xMax)/2, cy = (view.yMin + view.yMax)/2;
  const xSpan = (view.xMax - view.xMin) * f, ySpan = (view.yMax - view.yMin) * f;
  view.xMin = cx - xSpan/2; view.xMax = cx + xSpan/2;
  view.yMin = cy - ySpan/2; view.yMax = cy + ySpan/2;
  clampView(); applyView();
}
function zoomOut(f=0.8){
  if(!view) return;
  const cx = (view.xMin + view.xMax)/2, cy = (view.yMin + view.yMax)/2;
  const xSpan = (view.xMax - view.xMin) / f, ySpan = (view.yMax - view.yMin) / f;
  view.xMin = cx - xSpan/2; view.xMax = cx + xSpan/2;
  view.yMin = cy - ySpan/2; view.yMax = cy + ySpan/2;
  clampView(); applyView();
}
function panX(pct=0.2){
  if(!view) return;
  const dx = (view.xMax - view.xMin) * pct;
  view.xMin += dx; view.xMax += dx;
  clampView(); applyView();
}
function fit(){ if(baseRange){ view = { ...baseRange }; applyView(); } }

/* ===== Simula√ß√£o ===== */
function captureParams(){
  return {
    years: parseInt($("years").value)||10,
    npaths: clamp(parseInt($("npaths").value)||5000, 10, 50000),
    rho: clamp(parseFloat($("rho").value)||0.2, -0.9, 0.95),
    rf: parseFloat($("rf").value)||6,
    seed: parseInt($("seed").value)||12345,
    S0: parseFloat($("S0").value)||10000,
    aport: parseFloat($("aport").value)||0
  };
}
function runSimulation(fast=false){
  const params = captureParams();
  const sel = assets.filter(a=>a.enabled);
  if(sel.length===0){ $("status").textContent="Selecione/adicione pelo menos um ativo."; return; }
  let sum = sel.reduce((s,a)=>s + (isFinite(a.weight)?a.weight:0), 0);
  if(sum<=0){ sel.forEach(a=>a.weight=1/sel.length); }
  else sel.forEach(a=>a.weight=a.weight/sum);
  assets = assets.map(a=>{ const f = sel.find(s=>s.symbol===a.symbol); return f ? {...a, weight:f.weight} : a; });

  $("status").textContent = fast ? "Simulando (r√°pido)..." : "Simulando em segundo plano...";
  spin(true);
  const t0 = performance.now();

  worker.postMessage({
    assets: assets,
    years: params.years,
    npaths: fast ? Math.max(50, Math.floor(params.npaths/5)) : params.npaths,
    rho: params.rho,
    rfAA: params.rf/100,
    S0: params.S0,
    aport: params.aport,
    seed: params.seed,
    samplePaths: 60
  });

  worker.onmessage = (ev)=>{
    spin(false);
    const t1 = performance.now();
    if(ev.data.error){ $("status").textContent = ev.data.error; toast(ev.data.error); return; }
    const { xs, sampled, finals, mean, median, p5, p95, retAA, volAA, sharpe, finalByAsset, assets: used } = ev.data;

    $("m_mean").textContent   = "R$ " + fmtBR(mean);
    $("m_median").textContent = "R$ " + fmtBR(median);
    $("m_p").textContent      = `P5: R$ ${fmtBR(p5)} | P95: R$ ${fmtBR(p95)}`;
    $("m_rv").textContent     = `${(retAA*100).toFixed(2)}% / ${(volAA*100).toFixed(2)}%`;
    $("m_sharpe").textContent = sharpe.toFixed(2);

    const body = $("byAssetBody"); body.innerHTML = "";
    used.forEach((a,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${a.symbol}</td><td>${(a.weight*100).toFixed(1)}%</td>
                      <td>${(+a.exp_return_aa).toFixed(2)}</td><td>${(+a.vol_1y_aa).toFixed(2)}</td>
                      <td>R$ ${fmtBR(finalByAsset[i])}</td>`;
      body.appendChild(tr);
    });

    drawCharts(xs, sampled, finals);
    $("status").textContent = `Pronto em ${(t1 - t0).toFixed(0)} ms (${finals.length} caminhos).`;
    toast("Simula√ß√£o conclu√≠da");
  };
}

/* ===== Eventos dos bot√µes de zoom/pan ===== */
$("zoomIn")   ?.addEventListener("click", ()=>zoomIn(0.8));
$("zoomOut")  ?.addEventListener("click", ()=>zoomOut(0.8));
$("panLeft")  ?.addEventListener("click", ()=>panX(-0.2));
$("panRight") ?.addEventListener("click", ()=>panX(+0.2));
$("fit")      ?.addEventListener("click", fit);
$("resetZoomPaths")?.addEventListener("click", fit);

/* ===== Boot ===== */
renderCatalog();
assets = [
  {enabled:true,  symbol:CATALOG[2].symbol, exp_return_aa:CATALOG[2].exp_return_aa, vol_1y_aa:CATALOG[2].vol_1y_aa, weight:0.5},
  {enabled:true,  symbol:CATALOG[6].symbol, exp_return_aa:CATALOG[6].exp_return_aa, vol_1y_aa:CATALOG[6].vol_1y_aa, weight:0.5},
];
renderAssets();
$("runBtn").addEventListener("click", ()=>runSimulation(false));
$("sampleBtn").addEventListener("click", ()=>runSimulation(true));
window.addEventListener("load", ()=> setTimeout(()=>runSimulation(true), 250));
</script>

<!-- toast & spinner -->
<div class="toast" id="toast"></div>
<div class="spinner" id="spinner">
  <div class="dot"></div><div class="dot"></div><div class="dot"></div>
</div>
</body>
</html>
